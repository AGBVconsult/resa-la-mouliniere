# Audit Complet MVP — La Moulinière

**Date :** 8 janvier 2026

---

## 1. BACKEND (Convex) — État d'implémentation

### ✅ FAIT — Fonctionnel

| Module | Fonctionnalité | Fichier |
|--------|----------------|---------|
| **Réservations** | Création réservation (`reservations.create`) | `convex/reservations.ts` |
| | Annulation par token (`cancelByToken`) | `convex/reservations.ts` |
| | Lecture par token (`getByToken`) | `convex/reservations.ts` |
| | Gestion idempotence | ✅ |
| | Routage groupRequest (≥16 pers) | ✅ |
| **Disponibilités** | `availability.getDay` (slots + capacité temps réel) | `convex/availability.ts` |
| | `availability.getMonth` (calendrier mensuel) | `convex/availability.ts` |
| | Overrides (MANUAL > PERIOD > SLOT) | ✅ |
| **Emails** | Queue d'emails (`emails.enqueue`) | `convex/emails.ts` |
| | Worker (`emails.processQueue`) | `convex/emails.ts` |
| | Templates 5 langues (FR/NL/EN/DE/IT) | `convex/lib/email/templates.ts` |
| | Retry avec backoff exponentiel | ✅ |
| | Cleanup + Reaper | ✅ |
| **Admin API** | `admin.listReservations` (pagination) | `convex/admin.ts` |
| | `admin.getReservation` | `convex/admin.ts` |
| | `admin.updateReservation` (status + tables) | `convex/admin.ts` |
| | State machine transitions | `convex/lib/stateMachine.ts` |
| **Slots** | `slots.seedRange` / `closeRange` / `openRange` | `convex/slots.ts` |
| **Crons** | Email queue (1 min) | `convex/crons.ts` |
| | Rappels J-1 (18h) | ✅ |
| | Cleanup (4h) | ✅ |

### ⚠️ PARTIELLEMENT FAIT

| Fonctionnalité | État | Manque |
|----------------|------|--------|
| **Séquence emails** | 5/7 types | ❌ `reservation.review` (J+1) non déclenché automatiquement |
| **Notification admin** | ❌ | Email admin quand résa `pending` créée |
| **Réponse email → message admin** | ❌ | Pas de webhook Resend/inbound email |

### ❌ NON FAIT — Backend

| Fonctionnalité | Impact MVP |
|----------------|------------|
| **Email `reservation.review` (J+1)** | Cron manquant pour envoyer demande d'avis J+1 après visite |
| **Notification admin (pending)** | Admin pas notifié quand résa en attente |
| **Inbound email (réponse client)** | Pas de webhook pour recevoir réponses email |
| **`jobs.dailyFinalize`** | Marquage automatique no-show (commenté dans crons) |
| **Création réservation admin** | API existe mais mutation `_create` source="admin" non exposée publiquement |

---

## 2. FRONTEND CLIENT (Widget) — État d'implémentation

### ✅ FAIT — Fonctionnel

| Fonctionnalité | Fichier |
|----------------|---------|
| **Widget 5 étapes** | `src/app/widget/components/Widget.tsx` |
| **Step 1** — Sélection convives + options | `Step1Guests.tsx` |
| **Step 2** — Calendrier + créneaux temps réel | `Step2DateTime.tsx` + `MonthCalendar.tsx` |
| **Step 3** — Formulaire contact | `Step3Contact.tsx` |
| **Step 4** — Récap + CGV + Turnstile | `Step4Policy.tsx` |
| **Step 5** — Confirmation | `Step5Confirmation.tsx` |
| **i18n 5 langues** | `src/components/booking/i18n/translations.ts` |
| **Détection langue navigateur** | ✅ |
| **Routage groupe (>15)** | `/widget/group-request` |
| **Page gestion réservation** | `src/app/reservation/[token]/page.tsx` |
| **Annulation via token** | ✅ |

### ❌ NON FAIT — Frontend Client

| Fonctionnalité | Impact |
|----------------|--------|
| **Modification réservation** | Page `/reservation/[token]/edit` n'existe pas |

---

## 3. FRONTEND ADMIN — État d'implémentation

### ❌ NON FAIT — Interface Admin

| Fonctionnalité MVP | État |
|--------------------|------|
| **Vue Service journalière** | ❌ Pas de page `/admin` |
| **Liste réservations du jour** | ❌ (API prête, UI manquante) |
| **Gestion statuts** (pending → confirmed → seated → completed/noshow) | ❌ (API prête, UI manquante) |
| **Attribution tables click-to-click** | ❌ (API prête, UI manquante) |
| **Création réservation manuelle** | ❌ (API à exposer + UI) |
| **Recherche client** | ❌ |

---

## 4. EMAILS — Séquence MVP

| Type Email | Backend | Déclenché | Template 5 langues |
|------------|---------|-----------|-------------------|
| `reservation.confirmed` | ✅ | ✅ Auto (partySize ≤ 4) | ✅ |
| `reservation.pending` | ✅ | ✅ Auto (partySize > 4) | ✅ |
| `reservation.validated` | ✅ | ❌ Manque trigger admin | ✅ |
| `reservation.refused` | ✅ | ❌ Manque trigger admin | ✅ |
| `reservation.cancelled` | ✅ | ✅ Auto (cancelByToken) | ✅ |
| `reservation.reminder` | ✅ | ✅ Cron J-1 18h | ✅ |
| `reservation.review` | ✅ | ❌ **Cron J+1 manquant** | ✅ |

---

## 5. SYNTHÈSE — Ce qui manque pour le MVP

### Priorité CRITIQUE (bloquant)

1. **Interface Admin complète**
   - Vue Service (liste réservations jour/service)
   - Gestion statuts avec boutons
   - Attribution tables (click-to-click)
   - Création réservation manuelle (téléphone/walk-in)

2. **Emails admin**
   - Notification quand réservation `pending` créée
   - Trigger email `validated` / `refused` depuis admin

3. **Page modification réservation client**
   - `/reservation/[token]/edit`

### Priorité HAUTE

4. **Email J+1 demande d'avis**
   - Cron `enqueueReviewEmails` à implémenter

5. **dailyFinalize (no-show automatique)**
   - Marquer `confirmed` → `noshow` si slot passé

### Priorité MOYENNE (nice-to-have MVP)

6. **Inbound email (réponse client → message admin)**
   - Webhook Resend ou alternative

---

## 6. ESTIMATION TRAVAIL RESTANT

| Composant | Effort estimé |
|-----------|---------------|
| **Interface Admin (Vue Service + CRUD)** | 3-4 jours |
| **Page modification réservation client** | 0.5 jour |
| **Emails admin (notification pending + triggers)** | 0.5 jour |
| **Cron email review J+1** | 0.5 jour |
| **dailyFinalize** | 0.5 jour |
| **Tests + polish** | 1-2 jours |

**Total estimé : 6-8 jours de développement**
