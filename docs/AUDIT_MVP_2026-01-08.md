# Audit Complet MVP — La Moulinière

**Date :** 16 février 2026 (mise à jour)

---

## 1. BACKEND (Convex) — État d'implémentation

### ✅ FAIT — Fonctionnel

| Module | Fonctionnalité | Fichier |
|--------|----------------|---------|
| **Réservations** | Création réservation (`reservations.create`) | `convex/reservations.ts` |
| | Annulation par token (`cancelByToken`) | `convex/reservations.ts` |
| | Lecture par token (`getByToken`) | `convex/reservations.ts` |
| | Gestion idempotence | ✅ |
| | Routage groupRequest (≥16 pers) | ✅ |
| **Disponibilités** | `availability.getDay` (slots + capacité temps réel) | `convex/availability.ts` |
| | `availability.getMonth` (calendrier mensuel) | `convex/availability.ts` |
| | Overrides (MANUAL > PERIOD > SLOT) | ✅ |
| **Emails** | Queue d'emails (`emails.enqueue`) | `convex/emails.ts` |
| | Worker (`emails.processQueue`) | `convex/emails.ts` |
| | Templates 5 langues (FR/NL/EN/DE/IT) | `convex/lib/email/templates.ts` |
| | Retry avec backoff exponentiel | ✅ |
| | Cleanup + Reaper | ✅ |
| | **Email review J+1** (`enqueueReviewEmails`) | ✅ `convex/emails.ts` |
| **Admin API** | `admin.listReservations` (pagination) | `convex/admin.ts` |
| | `admin.getReservation` | `convex/admin.ts` |
| | `admin.updateReservation` (status + tables) | `convex/admin.ts` |
| | **`admin.createReservation`** (téléphone/walk-in) | ✅ `convex/admin.ts` |
| | State machine transitions | `convex/lib/stateMachine.ts` |
| **Slots** | `slots.seedRange` / `closeRange` / `openRange` | `convex/slots.ts` |
| **Plan de salle** | `floorplan.getTableStates` (statuts temps réel) | `convex/floorplan.ts` |
| | `floorplan.assign` (assignation tables) | `convex/floorplan.ts` |
| | `floorplan.checkAssignment` (validation) | `convex/floorplan.ts` |
| **Tables** | `tables.list` / `create` / `update` / `delete` | `convex/tables.ts` |
| | `tables.updatePosition` (drag & drop) | `convex/tables.ts` |
| **Crons** | Email queue (1 min) | `convex/crons.ts` |
| | Rappels J-1 (18h) | ✅ |
| | **Review J+1 (10h)** | ✅ |
| | Cleanup (4h) | ✅ |
| | **dailyFinalize (3h)** | ✅ `convex/jobs.ts` |
| **Notifications** | **Email admin pending** | ✅ `convex/reservations.ts` |
| | **Push Pushover** | ✅ `convex/notifications.ts` |
| **Shadow Learning** | Logging assignations (Phase 1) | ✅ `convex/assignmentLogs.ts` |
| | **Prédictions ML (Phase 2)** | ✅ `convex/lib/setPredictor.ts` |
| | **Shadow metrics** | ✅ `convex/lib/shadowMetrics.ts` |

### ⚠️ PARTIELLEMENT FAIT

| Fonctionnalité | État | Manque |
|----------------|------|--------|
| **Réponse email → message admin** | ❌ | Pas de webhook Resend/inbound email |

### ❌ NON FAIT — Backend

| Fonctionnalité | Impact MVP |
|----------------|------------|
| **Inbound email (réponse client)** | Pas de webhook pour recevoir réponses email (nice-to-have) |

---

## 2. FRONTEND CLIENT (Widget) — État d'implémentation

### ✅ FAIT — Fonctionnel

| Fonctionnalité | Fichier |
|----------------|---------|
| **Widget 5 étapes** | `src/app/widget/components/Widget.tsx` |
| **Step 1** — Sélection convives + options | `Step1Guests.tsx` |
| **Step 2** — Calendrier + créneaux temps réel | `Step2DateTime.tsx` + `MonthCalendar.tsx` |
| **Step 3** — Formulaire contact | `Step3Contact.tsx` |
| **Step 4** — Récap + CGV + Turnstile | `Step4Policy.tsx` |
| **Step 5** — Confirmation | `Step5Confirmation.tsx` |
| **i18n 5 langues** | `src/components/booking/i18n/translations.ts` |
| **Détection langue navigateur** | ✅ |
| **Routage groupe (>15)** | `/widget/group-request` |
| **Page gestion réservation** | `src/app/reservation/[token]/page.tsx` |
| **Annulation via token** | ✅ |

### ✅ FAIT — Pages Client Complémentaires (Mise à jour 17/01)

| Fonctionnalité | Fichier | Notes |
|----------------|---------|-------|
| **Page modification réservation** | `src/app/reservation/[token]/edit/page.tsx` | Style widget, multilingue, options pré-cochées |
| **Page annulation réservation** | `src/app/reservation/[token]/cancel/page.tsx` | Style widget, multilingue, confirmation |

---

## 3. FRONTEND ADMIN — État d'implémentation

### ✅ FAIT — Interface Admin

| Fonctionnalité MVP | État |
|--------------------|------|
| **Vue Service journalière** | ✅ Page `/admin/reservations` créée |
| **Liste réservations du jour** | ✅ Avec pagination, filtres service |
| **Gestion statuts** (pending → confirmed → seated → completed/noshow/incident) | ✅ Boutons d'actions + menu contextuel |
| **Attribution tables click-to-click** | ✅ Plan de salle interactif + combinaison intelligente |
| **Création réservation manuelle** | ✅ `CreateReservationModal.tsx` + `admin.createReservation` |
| **Recherche client** | ❌ (nice-to-have) |
| **Tracking événements (ponctualité)** | ✅ Table reservationEvents + query stats |

---

## 4. EMAILS — Séquence MVP

| Type Email | Backend | Déclenché | Template 5 langues |
|------------|---------|-----------|-------------------|
| `reservation.confirmed` | ✅ | ✅ Auto (partySize ≤ 4) | ✅ |
| `reservation.pending` | ✅ | ✅ Auto (partySize > 4) | ✅ |
| `reservation.validated` | ✅ | ✅ Via `admin.updateReservation` | ✅ |
| `reservation.refused` | ✅ | ✅ Via `admin.updateReservation` | ✅ |
| `reservation.cancelled` | ✅ | ✅ Auto (cancelByToken) | ✅ |
| `reservation.reminder` | ✅ | ✅ Cron J-1 18h | ✅ |
| `reservation.review` | ✅ | ✅ Cron J+1 10h (`enqueueReviewEmails`) | ✅ |
| `admin.notification` | ✅ | ✅ Auto (pending créé) | ✅ |

---

## 5. SYNTHÈSE — APPLICATION EN PRODUCTION ✅

### ✅ MVP Complet + Améliorations Post-Release

1. **Interface Admin complète** ✅
   - ✅ Vue Service (liste réservations jour/service)
   - ✅ Gestion statuts avec boutons
   - ✅ Attribution tables (click-to-click) — Plan de salle interactif terminé (21/01)
   - ✅ Création réservation manuelle (téléphone/walk-in) — Terminé (22/01)

2. **Emails admin** ✅
   - ✅ Notification email quand réservation `pending` créée
   - ✅ Notification push Pushover quand réservation `pending` créée
   - ✅ Trigger email `validated` / `refused` via `admin.updateReservation`

3. **Page modification réservation client** ✅ Terminé (17/01)
   - `/reservation/[token]/edit` ✅
   - `/reservation/[token]/cancel` ✅

4. **Email J+1 demande d'avis** ✅ Terminé (22/01)
   - ✅ Cron `enqueueReviewEmails` implémenté (10h quotidien)
   - ✅ Exclut les réservations avec événement `incident` dans `reservationEvents`

5. **dailyFinalize** ✅ Terminé (22/01)
   - ✅ `confirmed` → `noshow` si slot passé (3h quotidien)
   - ✅ `seated` → `completed` si slot passé

6. **Shadow Learning (PRD-011)** ✅ Phase 2 active
   - ✅ Logging des assignations
   - ✅ Prédictions ML (scoring V0 rule-based)
   - ✅ Shadow metrics pour comparaison

7. **Interface Tablette** ✅ Terminé (02/02)
   - ✅ `/admin-tablette` — iPad paysage optimisé
   - ✅ CalendarPopup responsive iPad mini/Pro
   - ✅ Sélection automatique service selon l'heure

8. **Interface Mobile** ✅ Terminé (02/02)
   - ✅ `/admin-mobile` — iPhone optimisé
   - ✅ PWA icons avec logo La Moulinière

9. **Migration NextAuth** ✅ Terminé (02/02)
   - ✅ Remplacement de Clerk par NextAuth credentials
   - ✅ Auth simplifiée (email/password)

10. **Améliorations Widget** ✅ Terminé (03/02)
    - ✅ Popup fermeture (`ClosureNoticeModal.tsx`) multilingue
    - ✅ Filtrage créneaux passés (timezone-aware)
    - ✅ Badges CRM (NEW/Regular/VIP selon totalVisits)

### Nice-to-have (backlog)

- **Inbound email (réponse client → message admin)** — Webhook Resend
- **Recherche client** — Autocomplétion par nom/email/téléphone
- **Analytics avancées** — Dashboard dynamique

---

## 6. ESTIMATION TRAVAIL RESTANT

| Composant | Effort estimé |
|-----------|---------------|
| ~~**Interface Admin (Vue Service + CRUD)**~~ | ~~3-4 jours~~ ✅ Terminé (21/01) |
| ~~**Page modification réservation client**~~ | ~~0.5 jour~~ ✅ Terminé (17/01) |
| ~~**Plan de salle interactif**~~ | ~~1-2 jours~~ ✅ Terminé (21/01) |
| ~~**Bug primaryTableId**~~ | ~~0.5 jour~~ ✅ Corrigé |
| ~~**Création réservation manuelle**~~ | ~~0.5 jour~~ ✅ Terminé (22/01) |
| ~~**Emails admin (notification pending + triggers)**~~ | ~~0.5 jour~~ ✅ Terminé (22/01) |
| ~~**Cron email review J+1**~~ | ~~0.5 jour~~ ✅ Terminé (22/01) |
| ~~**dailyFinalize**~~ | ~~0.5 jour~~ ✅ Terminé (22/01) |
| ~~**Tests + polish**~~ | ~~1-2 jours~~ ✅ Terminé (24/01) |
| ~~**Interface Tablette**~~ | ~~1 jour~~ ✅ Terminé (02/02) |
| ~~**Interface Mobile**~~ | ~~1 jour~~ ✅ Terminé (02/02) |
| ~~**Migration NextAuth**~~ | ~~0.5 jour~~ ✅ Terminé (02/02) |
| ~~**Améliorations Widget**~~ | ~~0.5 jour~~ ✅ Terminé (03/02) |
| ~~**Calendrier tablette responsive**~~ | ~~0.5 jour~~ ✅ Terminé (05/02) |

**Total : APPLICATION EN PRODUCTION — Aucun travail bloquant restant**
