# Audit Complet MVP â€” La MouliniÃ¨re

**Date :** 18 janvier 2026 (mise Ã  jour)

---

## 1. BACKEND (Convex) â€” Ã‰tat d'implÃ©mentation

### âœ… FAIT â€” Fonctionnel

| Module | FonctionnalitÃ© | Fichier |
|--------|----------------|---------|
| **RÃ©servations** | CrÃ©ation rÃ©servation (`reservations.create`) | `convex/reservations.ts` |
| | Annulation par token (`cancelByToken`) | `convex/reservations.ts` |
| | Lecture par token (`getByToken`) | `convex/reservations.ts` |
| | Gestion idempotence | âœ… |
| | Routage groupRequest (â‰¥16 pers) | âœ… |
| **DisponibilitÃ©s** | `availability.getDay` (slots + capacitÃ© temps rÃ©el) | `convex/availability.ts` |
| | `availability.getMonth` (calendrier mensuel) | `convex/availability.ts` |
| | Overrides (MANUAL > PERIOD > SLOT) | âœ… |
| **Emails** | Queue d'emails (`emails.enqueue`) | `convex/emails.ts` |
| | Worker (`emails.processQueue`) | `convex/emails.ts` |
| | Templates 5 langues (FR/NL/EN/DE/IT) | `convex/lib/email/templates.ts` |
| | Retry avec backoff exponentiel | âœ… |
| | Cleanup + Reaper | âœ… |
| **Admin API** | `admin.listReservations` (pagination) | `convex/admin.ts` |
| | `admin.getReservation` | `convex/admin.ts` |
| | `admin.updateReservation` (status + tables) | `convex/admin.ts` |
| | State machine transitions | `convex/lib/stateMachine.ts` |
| **Slots** | `slots.seedRange` / `closeRange` / `openRange` | `convex/slots.ts` |
| **Crons** | Email queue (1 min) | `convex/crons.ts` |
| | Rappels J-1 (18h) | âœ… |
| | Cleanup (4h) | âœ… |

### âš ï¸ PARTIELLEMENT FAIT

| FonctionnalitÃ© | Ã‰tat | Manque |
|----------------|------|--------|
| **SÃ©quence emails** | 5/7 types | âŒ `reservation.review` (J+1) non dÃ©clenchÃ© automatiquement |
| **Notification admin** | âŒ | Email admin quand rÃ©sa `pending` crÃ©Ã©e |
| **RÃ©ponse email â†’ message admin** | âŒ | Pas de webhook Resend/inbound email |

### âŒ NON FAIT â€” Backend

| FonctionnalitÃ© | Impact MVP |
|----------------|------------|
| **Email `reservation.review` (J+1)** | Cron manquant pour envoyer demande d'avis J+1 aprÃ¨s visite |
| **Notification admin (pending)** | Admin pas notifiÃ© quand rÃ©sa en attente |
| **Inbound email (rÃ©ponse client)** | Pas de webhook pour recevoir rÃ©ponses email |
| **`jobs.dailyFinalize`** | Marquage automatique no-show (commentÃ© dans crons) |
| **CrÃ©ation rÃ©servation admin** | API existe mais mutation `_create` source="admin" non exposÃ©e publiquement |

---

## 2. FRONTEND CLIENT (Widget) â€” Ã‰tat d'implÃ©mentation

### âœ… FAIT â€” Fonctionnel

| FonctionnalitÃ© | Fichier |
|----------------|---------|
| **Widget 5 Ã©tapes** | `src/app/widget/components/Widget.tsx` |
| **Step 1** â€” SÃ©lection convives + options | `Step1Guests.tsx` |
| **Step 2** â€” Calendrier + crÃ©neaux temps rÃ©el | `Step2DateTime.tsx` + `MonthCalendar.tsx` |
| **Step 3** â€” Formulaire contact | `Step3Contact.tsx` |
| **Step 4** â€” RÃ©cap + CGV + Turnstile | `Step4Policy.tsx` |
| **Step 5** â€” Confirmation | `Step5Confirmation.tsx` |
| **i18n 5 langues** | `src/components/booking/i18n/translations.ts` |
| **DÃ©tection langue navigateur** | âœ… |
| **Routage groupe (>15)** | `/widget/group-request` |
| **Page gestion rÃ©servation** | `src/app/reservation/[token]/page.tsx` |
| **Annulation via token** | âœ… |

### âœ… FAIT â€” Pages Client ComplÃ©mentaires (Mise Ã  jour 17/01)

| FonctionnalitÃ© | Fichier | Notes |
|----------------|---------|-------|
| **Page modification rÃ©servation** | `src/app/reservation/[token]/edit/page.tsx` | Style widget, multilingue, options prÃ©-cochÃ©es |
| **Page annulation rÃ©servation** | `src/app/reservation/[token]/cancel/page.tsx` | Style widget, multilingue, confirmation |

---

## 3. FRONTEND ADMIN â€” Ã‰tat d'implÃ©mentation

### ğŸŸ¡ EN COURS â€” Interface Admin

| FonctionnalitÃ© MVP | Ã‰tat |
|--------------------|------|
| **Vue Service journaliÃ¨re** | âœ… Page `/admin/reservations` crÃ©Ã©e |
| **Liste rÃ©servations du jour** | âœ… Avec pagination, filtres service |
| **Gestion statuts** (pending â†’ confirmed â†’ seated â†’ completed/noshow/incident) | âœ… Boutons d'actions + menu contextuel |
| **Attribution tables click-to-click** | âŒ (API prÃªte, UI manquante) |
| **CrÃ©ation rÃ©servation manuelle** | âŒ (API Ã  exposer + UI) |
| **Recherche client** | âŒ |
| **Tracking Ã©vÃ©nements (ponctualitÃ©)** | âœ… Table reservationEvents + query stats |

---

## 4. EMAILS â€” SÃ©quence MVP

| Type Email | Backend | DÃ©clenchÃ© | Template 5 langues |
|------------|---------|-----------|-------------------|
| `reservation.confirmed` | âœ… | âœ… Auto (partySize â‰¤ 4) | âœ… |
| `reservation.pending` | âœ… | âœ… Auto (partySize > 4) | âœ… |
| `reservation.validated` | âœ… | âŒ Manque trigger admin | âœ… |
| `reservation.refused` | âœ… | âŒ Manque trigger admin | âœ… |
| `reservation.cancelled` | âœ… | âœ… Auto (cancelByToken) | âœ… |
| `reservation.reminder` | âœ… | âœ… Cron J-1 18h | âœ… |
| `reservation.review` | âœ… | âŒ **Cron J+1 manquant** | âœ… |

---

## 5. SYNTHÃˆSE â€” Ce qui manque pour le MVP

### PrioritÃ© CRITIQUE (bloquant)

1. **Interface Admin complÃ¨te**
   - âœ… Vue Service (liste rÃ©servations jour/service)
   - âœ… Gestion statuts avec boutons
   - âŒ Attribution tables (click-to-click)
   - âŒ CrÃ©ation rÃ©servation manuelle (tÃ©lÃ©phone/walk-in)

2. **Emails admin**
   - Notification quand rÃ©servation `pending` crÃ©Ã©e
   - Trigger email `validated` / `refused` depuis admin

3. ~~**Page modification rÃ©servation client**~~ âœ… TerminÃ© (17/01)
   - `/reservation/[token]/edit` âœ…
   - `/reservation/[token]/cancel` âœ…

### PrioritÃ© HAUTE

4. **Email J+1 demande d'avis**
   - Cron `enqueueReviewEmails` Ã  implÃ©menter
   - âš ï¸ **Blocage si statut `incident`** : Le cron doit exclure les rÃ©servations avec `status === "incident"` pour ne pas envoyer de demande d'avis aux clients ayant eu un incident (table `reservationEvents` disponible pour audit)

5. **dailyFinalize (no-show automatique)**
   - Marquer `confirmed` â†’ `noshow` si slot passÃ©

### PrioritÃ© MOYENNE (nice-to-have MVP)

6. **Inbound email (rÃ©ponse client â†’ message admin)**
   - Webhook Resend ou alternative

---

## 6. ESTIMATION TRAVAIL RESTANT

| Composant | Effort estimÃ© |
|-----------|---------------|
| **Interface Admin (Vue Service + CRUD)** | ~~3-4 jours~~ 1-2 jours restants |
| ~~**Page modification rÃ©servation client**~~ | ~~0.5 jour~~ âœ… TerminÃ© |
| **Emails admin (notification pending + triggers)** | 0.5 jour |
| **Cron email review J+1** | 0.5 jour |
| **dailyFinalize** | 0.5 jour |
| **Tests + polish** | 1-2 jours |

**Total estimÃ© : 3-5 jours de dÃ©veloppement restants**
